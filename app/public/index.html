<!DOCTYPE html>
<html>

	<head lang="en">
		<meta charset="UTF-8">
		<title>报名页面</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta name="format-detection" content="telephone=no" />
		<meta name="renderer" content="webkit" />
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<link rel="stylesheet" href="assets/css/amazeui.css" />
		<link rel="stylesheet" href="assets/css/app.css" />
		<link rel="stylesheet" href="assets/css/index.css" />
		<link rel="icon" href="assets/i/logo.png" />
	</head>

	<body>
		<div class="am-topbar am-topbar-fixed-top">
			<div class="am-container">
				<h1 class="am-topbar-brand am-margin-right-sm web_title">
      				<a href="index.html"><img src="assets/i/logo.png" class="logo">中国大学生医药数学建模</a>
    			</h1>

				<button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-secondary am-show-sm-only" data-am-collapse="{target: '#collapse-head'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span>
				</button>

				<div class="am-collapse am-topbar-collapse" id="collapse-head">
					<ul class="am-nav am-nav-pills am-topbar-nav">
						<li><a href="http://nmcmm.wmu.edu.cn/front/index.html">首页</a>
						</li>
						<li><a href="http://nmcmm.wmu.edu.cn/front/constitution.html">竞赛章程</a>
						</li>
						<li><a href="http://nmcmm.wmu.edu.cn/front/rules.html">竞赛规范</a>
						</li>
						<li><a href="http://nmcmm.wmu.edu.cn/front/trainl.html">科研培训</a>
						</li>
						<li><a href="http://nmcmm.wmu.edu.cn/front/news.html">最新动态</a>
						</li>
						<li><a href="http://nmcmm.wmu.edu.cn/front/sponsor.html">赞助单位</a>
						</li>
						<li><a href="http://nmcmm.wmu.edu.cn/front/about.html">相关信息</a>
						</li>
					</ul>

				</div>
			</div>
		</div>

		<div class="main">
			<div class="app_sub_title am-margin-bottom-xs">
				<div class="am-container">
					<h1 class="app_sub_title_h1" data-am-scrollspy="{animation:'slide-left', repeat: true}">报名信息录入系统</h1>
					<div class="am-g">
						<div class="am-u-lg-12 am-u-md-12 am-u-sm-12">
							<p class="app_sub_title_p" data-am-scrollspy="{animation:'slide-right', repeat: true}">Registration information input system</p>
						</div>
					</div>
				</div>
			</div>

			<div class="am-container am-margin-top-xl">
				<div class="am-g">
					<div class="am-u-md-3">
						<!--
                    	作者：692270687@qq.com
                    	时间：2015-04-17
                    	描述：一般信息
                    -->
					<div class="am-list-news am-list-news-default am-hide-sm-only" data-am-sticky="{top:80}">
						<!--列表标题-->
						<div class="am-list-news-bd">
							<ul class="am-list">
								<hr style="background-color: #009CDA; padding: 1px 0px;" />
								<li class="am-g am-list-item-desced am-padding-left-sm">

									<span class="am-list-item-hd" style="font-size: 14px;font-weight: 800;"> <i class="am-icon-arrow-right"></i> 作品提交邮箱</span>
									<div class="am-list-item-text" style="font-size: 12px;text-indent: 1em;">nmcmm_cn@163.com</div>
								</li>

								<li class="am-g am-list-item-desced am-padding-left-sm">
									<span class="am-list-item-hd" style="font-size: 14px;font-weight: 800;"> <i class="am-icon-arrow-right"></i> QQ群</span>
									<div class="am-list-item-text" style="font-size: 12px;text-indent: 1em;">
										中国生物医药数学模型群（392104853）
									</div>
								</li>

								<li class="am-g am-list-item-desced am-padding-left-sm">
									<span class="am-list-item-hd" style="font-size: 14px;font-weight: 800;"> <i class="am-icon-arrow-right"></i> 微信群</span>
									<div class="am-list-item-text" style="font-size: 12px;text-indent: 1em;">
										中国生物医药数学模型群
									</div>
									<img src="assets/i/Screenshot_2015-05-21-16-49-04.png" class="am-img-responsive" style="width: 90%;height: auto;margin-top: 5px;">
								</li>
							</ul>
						</div>
					</div>
					</div>
					<div class="am-u-md-9">
						<div class="am-panel-group" style="font-size: 1.5rem;" id="accordion">

							<div class="am-panel am-panel-default">
								<div class="am-panel-hd">
									<h4 class="am-panel-title">报名信息录入须知</h4>
								</div>
								<div id="do-not-say-3" class="am-panel-collapse am-collapse am-in">
									<div class="am-panel-bd">
										根据全国组委会通知精神，各校报名参加2016年竞赛的队数上限不作统一规定。请各参赛院校于5月10日前寄送“2016年中国大学生医药数学建模竞赛参赛信息表”（见附件二）（纸质文本，需加盖公章），并登陆中国大学生医药数学建模竞赛网站（http://nmcmm.wmu.edu.cn/）进行参赛队数网上确认，若学校竞赛负责人信息有变更，请及时修改。请各参赛院校于<strong>5月10日前将本校参赛学生信息录入到中国大学生医药数学建模竞赛网的报名信息录入系统</strong>,逾期不再受理报名也不能更改报名信息。
									</div>
								</div>
							</div>

							<div class="am-panel am-panel-default">
								<div class="am-panel-hd">
									<h4 class="am-panel-title">队伍信息录入</h4>
								</div>
								<div  class="am-panel-collapse am-collapse am-in">
									<div class="am-panel-bd am-padding-top-xl">
										<form class="am-form am-form-horizontal" style="font-size:12px;color:#666;">
											<div class="am-form-group" >
										    	<label for="J_school" class="am-u-sm-2 am-form-label">*学校全称</label>
										    	<div class="am-u-sm-10">
										      		<input type="text" id="J_school" style="font-size:12px;" placeholder="输入您所在学校全称">
										    	</div>
										  	</div>

											<div class="am-form-group">
										    	<label for="J_group" class="am-u-sm-2 am-form-label">*参赛组别</label>
										    	<div class="am-u-sm-10">
										      		<input type="text" id="J_group" style="font-size:12px;" placeholder="输入您所在参赛组别">
										    	</div>
										  	</div>

											<div class="am-form-group">
										    	<label for="J_teacher" class="am-u-sm-2 am-form-label">*指导老师</label>
										    	<div class="am-u-sm-10">
										      		<input type="text" id="J_teacher" style="font-size:12px;" placeholder="输入您所在组的参赛组别">
										    	</div>
										  	</div>

										</form>
									</div>
								</div>
							</div>

							<div class="am-panel am-panel-default">
								<div class="am-panel-hd">
									<h4 class="am-panel-title">队员信息录入</h4>
								</div>
								<div  class="am-panel-collapse am-collapse am-in">
									<div class="am-panel-bd">
										<form class="am-form am-form-horizontal" style="font-size:12px;color:#666;" id="J_group-list">

										  	<div class="am-form-group" id="J_form-operate">
										    	<div class="am-u-sm-12 am-text-center am-margin-top">
													<button type="button" id="J_add-group" class="am-btn am-btn-default am-margin-sm">添加队员</button>
										      		<button type="button" id="J_submit" class="am-btn am-btn-primary am-margin-sm">提交信息</button>
										    	</div>
										  	</div>
										</form>
									</div>
								</div>
							</div>

							<div class="am-panel am-panel-default" id="J_root-operate" style="display:none">
								<div class="am-panel-hd">
									<h4 class="am-panel-title">管理员功能</h4>
								</div>
								<div  class="am-panel-collapse am-collapse am-in">
									<div class="am-panel-bd ">
										您好，该模块只对管理员开放。<strong>"清空数据"</strong>只清空当前的数据，备份的数据不会丢失。本系统已开启了自动备份的功能（每天会自动备份一次数据）。如果当天数据出现异常，请点击<strong>"回滚数据"</strong>还原到上一个版本，为了防止数据丢失，回滚前请先点击下面的<strong>"备份数据"</strong>的按钮手动备份当前数据。如果问题仍然无法解决，请及时联系开发者。
										<form class="am-form am-form-horizontal" style="font-size:12px;color:#666;">
											<div class="am-form-group" >
										    	<div class="am-u-sm-12 am-margin-top am-text-center">
													<button type="button" id="J_copy-data" class="am-btn am-btn-default am-margin-sm">备份数据</button>
													<button type="button" id="J_revert-data" class="am-btn am-btn-warning am-margin-sm">回滚数据</button>
										      		<button type="button" id="J_download" class="am-btn am-btn-primary am-margin-sm">下载excel</button>
													<button type="button" id="J_delete-data" class="am-btn am-btn-danger am-margin-sm">清空数据</button>
										    	</div>
										  	</div>

											<div id="J_revert-field" style="display: none">
												<hr/>
												<div class="am-form-group">
											    	<label for="J_teacher" class="am-u-sm-2 am-form-label">*回滚版本</label>
											    	<div class="am-u-sm-10">
											      		<select  id="J_revert-key" style="font-size:12px;" >
															<option data-key="current">当前备份的版本</option>
														</select>
											    	</div>
											  	</div>
												<div class="am-form-group">
											    	<button type="button" style="width:94.5%;margin-left:3%" id="J_revert-confirm" class="am-btn am-btn-warning">确定回滚</button>
											  	</div>
											</div>
										</form>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<hr />

		<div class="footer" style="position: relative;">
			<div data-am-widget="gotop" class="am-gotop am-gotop-fixed">
				<a href="#top" title="回到顶部">
					<span class="am-gotop-title">回到顶部</span>
					<i class="am-gotop-icon am-icon-chevron-up"></i>
				</a>
			</div>
			<p>© copying right 2015 中国医药数学委员会、温州医科大学数学委员会
				<br/> <small>技术支持：温州smart网络科技有限公司</small>
			</p>
		</div>

		<div id="all_operate"></div>

		<!--[if lt IE 9]>
<script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
<script src="http://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
<script src="assets/js/polyfill/rem.min.js"></script>
<script src="assets/js/polyfill/respond.min.js"></script>
<script src="assets/js/amazeui.legacy.js"></script>
<![endif]-->

		<!--[if (gte IE 9)|!(IE)]><!-->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/amazeui.min.js"></script>
		<!--<![endif]-->
		<script src="assets/js/Common_model.js"></script>

		<script type="text/javascript">
			$(function(){
				var myapp = (function() {
					// 入口
					var init = function() {
						eventBind();
						superPart();
					};
					// 事件绑定
					var eventBind = function() {
						// 添加队员
						$('#J_add-group').on('click', function() {
							var tpl = [
								'<div class="J_group-item" style="border-bottom:1px solid #eee;padding-bottom: 10px;position:relative;padding-top:30px;margin-top:10px;">',
									'<a href="javascript:void(0)" class="J_group-delete" style="position: absolute; right: 0;top:0px;font-size:13px;">删除队员</a>',
									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">*姓名</label>',
										'<div class="am-u-sm-10">',
											'<input type="text" class="J_group-name" style="font-size:12px;" placeholder="输入队员的姓名">',
										'</div>',
									'</div>',

									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">*角色</label>',
										'<div class="am-u-sm-10">',
											'<select class="J_group-role" style="font-size:12px;">',
												'<option data-id="0">队员</option>',
												'<option data-id="1">队长</option>',
											'</select>',
										'</div>',
									'</div>',

									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">*身份证号</label>',
										'<div class="am-u-sm-10">',
											'<input type="text" class="J_group-IDcard" style="font-size:12px;" placeholder="输入队员的身份证号">',
										'</div>',
									'</div>',

									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">*学号</label>',
										'<div class="am-u-sm-10">',
											'<input type="text" class="J_group-code" style="font-size:12px;" placeholder="输入队员的学号">',
										'</div>',
									'</div>',

									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">*学院全称</label>',
										'<div class="am-u-sm-10">',
											'<input type="text" class="J_group-college" style="font-size:12px;" placeholder="输入队员的学院全称">',
										'</div>',
									'</div>',

									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">*专业全称</label>',
										'<div class="am-u-sm-10">',
											'<input type="text" class="J_group-major" style="font-size:12px;" placeholder="输入队员的专业全称">',
										'</div>',
									'</div>',

									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">*年级</label>',
										'<div class="am-u-sm-10">',
											'<input type="text" class="J_group-grade" style="font-size:12px;" placeholder="输入队员的年级">',
										'</div>',
									'</div>',

									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">*手机号码</label>',
										'<div class="am-u-sm-10">',
											'<input type="tel" class="J_group-telphone" style="font-size:12px;" placeholder="输入队员的手机号码">',
										'</div>',
									'</div>',

									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">*邮箱地址</label>',
										'<div class="am-u-sm-10">',
											'<input type="email" class="J_group-email" style="font-size:12px;" placeholder="输入队员的邮箱地址">',
										'</div>',
									'</div>',

									'<div class="am-form-group">',
										'<label class="am-u-sm-2 am-form-label">备注(可选)</label>',
										'<div class="am-u-sm-10">',
											'<textarea rows="8" cols="20" class="J_group-note" style="font-size:12px;height:60px;" placeholder="输入队员的备注信息"></textarea>',
										'</div>',
									'</div>',
								'</div>'
							].join('');
							$('#J_form-operate').before(tpl);
						});

						// 删除一项
						$(document).on('click', '.J_group-delete', function() {
							$(this).parent().remove();
						});

						// 提交信息
						$('#J_submit').on('click', function() {
							var data = {
								school: $('#J_school').val(),
								group: $('#J_group').val(),
								teacher: $('#J_teacher').val(),
								items: []
							};
							var _names = $('.J_group-name'),
								_roles = $(".J_group-role").find("option:selected"),
								_IDcards = $('.J_group-IDcard'),
								_codes = $('.J_group-code'),
								_colleges = $('.J_group-college'),
								_majors = $('.J_group-major'),
								_grades= $('.J_group-grade'),
								_telphones = $('.J_group-telphone'),
								_emails = $('.J_group-email'),
								_notes = $('.J_group-note');
							$.each($('.J_group-item'), function(i) {
								var item = {
									name: _names.eq(i).val(),
									role: _roles.eq(i).val(),
									IDcard: _IDcards.eq(i).val(),
									code: _codes.eq(i).val(),
									college: _colleges.eq(i).val(),
									major: _majors.eq(i).val(),
									grade: _grades.eq(i).val(),
									telphone: _telphones.eq(i).val(),
									email: _emails.eq(i).val(),
									note: _notes.eq(i).val()
								}
								data.items.push(item);
							});
							// 检查为空
							if (checkEmpty(data)) {
								// 检查是否设置了队长
								if (checkHasLeader(data)) {
									$.ajax({
										url: '/group/add',
										type: 'POST',
										dataType: 'json',
										data: data,
										success: function(res) {
											if (res.status) {
												alert(res.message);
											} else {
												alert('信息录入失败！请重试');
											}
										}
									});
								}
							};
						});
					};
					// 检查是否有关键内容为空
					var checkEmpty = function(data) {
						for (var obj in data) {
							if (!data[obj]) {
								alert(mapItemName(obj.toString()) + "不能为空！");
								$('#J_' + obj.toString()).focus();
								return false;
							}
							if (data.school && data.group && data.teacher && !data.items.length) {
								alert('队伍信息不能为空！');
								return false;
							} else if(data.items.length) {
								var finish = false;
								var res = data.items.forEach(function(item, i) {
									for (var aa in item) {
										if (!item[aa] && aa!= 'note') {
											alert(mapItemName(aa.toString()) + "不能为空！");
											$('.J_group-' + aa.toString()).eq(i).focus();
											finish = true;
											return false;
										}
									}
									finish = true;
								});
								if (finish) {
									return true;
								}
							}
						}
						return true;
					};
					// 检查是否设置了一名队长
					var checkHasLeader = function(data) {
						var len1 = 0, len2 = 0;
						data.items.forEach(function(item) {
							if (item.role === '队长') {
								len1 ++;
							}
							len2 ++;
						});
						if (len1) {
							if (len1 > 1) {
								alert('队伍只能设置一名队长！');
								$('.J_group-role').eq(len1-1).focus();
								return false;
							} else {
								if (len1 ===1 && len2 > 3) {
									alert('一个队伍人数不能超过3人！');
									return false;
								}
							}

						} else {
							alert('队伍必需设置一名队长！');
							$('.J_group-role').eq(0).focus();
							return false;
						}
						return true;
					}
					// 字段映射成相应的汉字
					var mapItemName = function(obj) {
						var returnStr = '';
						switch (obj) {
							case 'school':
								returnStr = '学校全称';
								break;
							case 'group':
								returnStr = '参赛组别';
								break;
							case 'teacher':
								returnStr = '执导老师';
								break;
							case 'name':
								returnStr = '姓名';
								break;
							case 'role':
								returnStr = '角色';
								break;
							case 'IDcard':
								returnStr = '身份证号';
								break;
							case 'code':
								returnStr = '学号';
								break;
							case 'college':
								returnStr = '学院全称';
								break;
							case 'major':
								returnStr = '专业全称';
								break;
							case 'grade':
								returnStr = '年级';
								break;
							case 'telphone':
								returnStr = '手机号码';
								break;
							case 'email':
								returnStr = '邮箱地址';
								break;
							default:
								break;
						}
						return returnStr;
					};
					// 高级功能
					var superPart = function() {
						var token = location.search.split('=');
						if (token[1] === 'root') {
							$('#J_root-operate').show();
						}

						// 下载excel
						$('#J_download').on('click', function() {
							location.href = "/group/xls";
						});

						// 执行手动备份
						$('#J_copy-data').on('click', function() {
							$.ajax({
								type: 'get',
								url: '/group/copy',
								dataType: 'json',
								success: function(res) {
									if (res.status) {
										alert(res.message);
									}
								}
							});
						});

						// 打开回滚操作域
						$('#J_revert-data').on('click', function() {
							$('#J_revert-field').toggle();
							// 获取可回滚的版本
							$.ajax({
								type: 'get',
								url: '/group/revert/list',
								dataType: 'json',
								success: function(res) {
									if (res.status) {
										var _html = ['<option data-key="current">当前备份的版本</option>'];
										res.data.forEach(function(item) {
											_html.push(
												'<option data-key="'+item+'">'+item+'的版本</option>'
											);
										});
										$('#J_revert-key').html(_html.join(''));
									}
								}
							})
						});

						// 执行回滚操作
						$('#J_revert-confirm').on('click', function() {
							$('#all_operate').empty();
							JafeneyComfirm("温馨提示", "您确定要执行回滚操作吗？");
							$('#JafeneyComfirm').modal({
								relatedTarget: this,
						        onConfirm: function(options) {
									var key = $('#J_revert-key').find('option:selected').data('key');
									$.ajax({
										url: '/group/revert',
										dataType: 'json',
										type: 'GET',
										data: {
											key: key
										},
										success: function(res) {
											if (res.status) {
												alert(res.message);
												$('#J_revert-field').hide();
											} else {
												alert("操作失败，请重试！");
											}
										}
									});
						        },
						        onCancel: function() {
						          //什么都不做
						        }
							});
						});

						// 清空数据
						$('#J_delete-data').on('click', function() {
							$('#all_operate').empty();
							JafeneyComfirm("温馨提示", "您确定要清空当前数据吗？");
							$('#JafeneyComfirm').modal({
								relatedTarget: this,
						        onConfirm: function(options) {
									$.ajax({
										url: '/group/delete',
										dataType: 'json',
										type: 'get',
										data: {
											id: "all"
										},
										success: function(res) {
											if (res.status) {
												alert("数据清空成功！");
											} else {
												alert("操作失败！请重试");
											}
										}
									});
						        },
						        onCancel: function() {
						          //什么都不做
						        }
							});
						});
					}
					init();
				})();
			});
		</script>
	</body>

</html>
